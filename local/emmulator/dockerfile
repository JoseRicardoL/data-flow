FROM amazonlinux:2

# Install essential packages
RUN yum update -y && \
    yum install -y java-1.8.0-openjdk python3 python3-pip python3-devel \
                   gcc git wget tar gzip && \
    yum clean all

# Create glue_user
RUN useradd -m -u 1000 glue_user && \
    mkdir -p /home/glue_user/.local /home/glue_user/workspace && \
    chown -R glue_user:glue_user /home/glue_user

# Set up Spark and Glue libraries
WORKDIR /opt
RUN wget https://archive.apache.org/dist/spark/spark-3.3.0/spark-3.3.0-bin-hadoop3.tgz && \
    tar -xzf spark-3.3.0-bin-hadoop3.tgz && \
    mv spark-3.3.0-bin-hadoop3 spark && \
    rm spark-3.3.0-bin-hadoop3.tgz

# Set environment variables
ENV SPARK_HOME=/opt/spark
ENV PATH=$PATH:$SPARK_HOME/bin
ENV PYTHONPATH=$SPARK_HOME/python:$SPARK_HOME/python/lib/py4j-0.10.9.5-src.zip:$PYTHONPATH

# Make sure we're using the system Python (without using alternatives)
RUN ln -sf /usr/bin/python3 /usr/local/bin/python3 && \
    python3 --version

# Install base Python packages
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install \
    boto3 \
    pyspark==3.3.0 \
    pandas \
    numpy \
    jupyter \
    jupyterlab \
    pyarrow \
    matplotlib \
    seaborn

# Setup working directory
WORKDIR /home/glue_user/workspace

# Configure Jupyter
RUN mkdir -p /home/glue_user/.jupyter && \
    echo "c.NotebookApp.token = ''" > /home/glue_user/.jupyter/jupyter_notebook_config.py && \
    echo "c.NotebookApp.password = ''" >> /home/glue_user/.jupyter/jupyter_notebook_config.py && \
    echo "c.NotebookApp.ip = '0.0.0.0'" >> /home/glue_user/.jupyter/jupyter_notebook_config.py && \
    chown -R glue_user:glue_user /home/glue_user/.jupyter

# Copy and set up entrypoint script
COPY local/emmulator/entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh && \
    chown glue_user:glue_user /usr/local/bin/entrypoint.sh

# Switch to glue_user
USER glue_user

# Use entrypoint script
CMD ["/usr/local/bin/entrypoint.sh"]